:toc:
:toc-placement!:

:note-caption: :information_source:
:tip-caption: :bulb:
:important-caption: :heavy_exclamation_mark:
:warning-caption: :warning:
:caution-caption: :fire:

= Software Development Environment
Ron Kurr <rkurr@jvmguy.com>

toc::[]

== Overview
This project is a Vagrant box that is provisioned for software development.  It is a Linux-based system and has many of the tools needed by a developer already installed.  The provisioning mechanism is based on Ansible and allows for user-specific customizations to be applied.

== Prerequisites

* https://www.vagrantup.com/[Vagrant] installed and working
* https://www.virtualbox.org/[VirtualBox] installed and working
* https://www.virtualbox.org/wiki/Downloads[VirtualBox Extension Pack] installed into VirtualBox
* https://en.wikipedia.org/wiki/X86_virtualization[Virtualization support] enabled in your BIOS
* a working internet connection
* Your corporate VPN running (if you want to apply some work-specific plays)

IMPORTANT: if you don't enable virtualization support in your BIOS, VirtualBox will not run correctly.

IMPORTANT: if you don't install the extension pack, the virtual machine won't come up, complaining about USB errors.

== Building
All the components of the environment live in repositories on the internet so there is nothing to build.

TIP: Some people have experienced issues when rebuilding a box due to flaky networks, online assets moving to different locations or installation processes changing.  When you need your box, you need your box and you don't have the time to troubleshoot an installation issue.  To combat this problem, we've decided to change the build model and bake in much of the software into the base image.  The trade-off we've made to ensure quick and stable rebuilds is a larger initial download.  All boxes are currently housed in https://app.vagrantup.com/kurron[HashiCorp's Vagrant Cloud] repository.

== Installation
Use Git to clone this project, go into the project folder and type `vagrant up` and go get a cup of coffee.  The construction time of the box greatly depends on your internet speeds.

.Xubuntu
image::xubuntu.png[Xubuntu]

.Xedora
image::xedora.png[Xedora]

== Tips and Tricks

=== Choice Of Distributions
We now support multiple Linux distributions.  If you run `vagrant status` you should see something like this:

```
vagrant status
Current machine states:

xubuntu                   not created (virtualbox)
xedhat                    not created (virtualbox)
```

`xubuntu` is the default but you can also run `vagrant up xedhat` to run
the Red Hat distribution.  You can run concurrent instances if you have the hardware and the need.

=== Upgrading
Sometimes the Vagrant file changes which can cause some subtle issues, such as creating an orphaned virtual machine. The safest upgrade procedure is the following:

1. `vagrant destroy` to remove the existing box
1. `git pull` to download the new files
1. **`vagrant box outdated`** to see if newer version of the box is available
1. `vagrant box update --box <boxname>` to pull down the current version of the box
1. `vagrant up` to build the new box

=== RAM and CPU Settings
If you examine the `vagrantfile` file, you will see that the virtual machine is configured to use 6GB of RAM and 2 CPUs.  Feel free to change these values to match your computer's hardware.

=== Low Disk Space
If an environment is used long enough, it is likely to run out of disk space.  The two main culprits are kernel updates filling up the `/boot` partition and Docker images filling up the `/var/lib/docker` partition.  You have at least 3 options:

* throw away the environment and start fresh
* clean up the old kernels via `sudo apt-get autoremove`
* clean up Docker containers via `docker rm --volumes --force $(docker ps --all --quiet)`
* clean up Docker images, after cleaning up the containers, via `docker rmi --force $(docker images --quiet)`

=== Verifying The Setup
Log into the system with a username of `vagrant` and password of `vagrant`.

=== Installed Infrastructure
Docker containers running common infrastructure are installed in `/home/vagrant/bin/servers`.  Look at the `docker-compose.yml` file to see what services are currently available to use.  Run the `start.sh` script to install and run the servers.  You can also start up a single server, eg `docker-compose up -d mongodb`.

=== Juniper VPN Support

1. Change into the `~/vagrant/VPN` folder
1. edit `jvpn.ini` changing the `username` and `password` values
1. run `./vpn.sh` to start your session
1. `ctrl-c` to exit the session

=== Docker-based IDEs
We've deprecated the use of Docker-based IDEs.  We've found that projects that produce and consume Docker images can be challenging when running from within a container.  If Docker in Docker ever becomes mainstream, we'll look into switching back.

=== Applying Your Company Specific Customizations
The system will look for an environment variable named `CORPORATE_PLAYS`.  If the shell running Vagrant specifies the variable such that it points to an Ansible project on GitHub, the plays will be run and the changes applied.  For example `export CORPORATE_PLAYS=kurron/ansible-pull-transparent.git` will result in https://github.com/kurron/ansible-pull-transparent.git[this playbook] getting run.  If the environment variable does not exist, the custom provisioning step is not run.

=== Applying Your Personal Customizations
The system will look for an environment variable named `USER_PLAYS`.  If the shell running Vagrant specifies the variable such that it points to an Ansible project on GitHub, the plays will be run and the changes applied.  For example `export USER_PLAYS=kurron/ansible-pull-desktop-tweaks.git` will result in https://github.com/kurron/ansible-pull-desktop-tweaks[this playbook] getting run.  If the environment variable does not exist, the custom provisioning step is not run.

IMPORTANT: Use a **copy** of the project if you decide to apply customizations. If you use the project referenced in the example, you will get somebody else's customizations, including Git configuration, which most certainly you do not want.

=== Customizations: Linux Example
1. create and/or edit `~/.bash_profile`
1. add the two variables and save the file
1. open a new shell
1. `echo $CORPORATE_PLAYS` to verify the new variable has been properly set
1. `echo $USER_PLAYS` to verify the new variable has been properly set
1. you **may** have to log out and back in again for the variables to take affect

```
export CORPORATE_PLAYS=kurron/ansible-pull-transparent.git
export USER_PLAYS=foo/custom-tweaks.git
```

=== Customizations: Windows 10 Example
1. In Search, search for and then select: System (Control Panel)
1. Click the Advanced system settings link.
1. Click Environment Variables.
1. In `User variables for ...` add `CORPORATE_PLAYS` variable, pointing it to your plays on GitHub
1. In `User variables for ...` add `USER_PLAYS` variable, pointing it to your plays on GitHub
1. In Search, search for and then select: Command (Command Prompt)
1. `echo %CORPORATE_PLAYS%` to verify that your new variable has been properly set
1. `echo %USER_PLAYS%` to verify that your new variable has been properly set

=== Gather Docker Container Metrics
`sudo csysdig -pcontainer` will fire up the sysdig tool.  Use `F2` to switch to the container view and see how each container is using system resources.  Explore some http://www.sysdig.org/wiki/sysdig-examples/[examples of how to use Sysdig] and see how can aid in troubleshooting.

=== Docker-only Box
If you don't need a full desktop but just the Docker engine, try using https://github.com/kurron/vagrant-docker-server[vagrant-docker-server]

=== Sub-Projects
TIP: We've moved away from using `ansible-pull` and to using http://docs.ansible.com/ansible/playbooks_roles.html[Ansible Roles], which give us a better mechanism for reusing provisioning logic.  You can find a https://galaxy.ansible.com/kurron/[list of available roles] in my Ansible Galaxy account.  More are sure to be included over time.

=== Installed Software (partial list)

* current http://zulu.org/[JDK]
* http://sdkman.io/[SDKMAN!] to manage various JVM tools, including Groovy, Kotlin, Scala, Clojure, Java, VisualVM, Vert.x, Grails, Gradle, sbt, Maven, Ant and Leiningen
* https://nodejs.org/en/[NodeJS] and https://www.npmjs.com/[npm]
* https://packer.io/[Packer]
* https://terraform.io/[Terraform]
* https://aws.amazon.com/cli/[AWS CLI]
* https://www.docker.com/[Docker]
* https://www.docker.com/products/docker-compose[Docker Compose]
* https://www.docker.com/products/docker-machine[Docker Machine]
* various http://www.jetbrains.com/[JetBrains IDEs]
* https://github.com/jkbrzt/httpie[httpie] - a more friendly alternative to cURL and wget

=== Different Windowing Systems
CAUTION: Currently in incubation.

We have branches that use different window managers that may appeal to you.  Use Git to switch to appropriate branch and run `vagrant up` to try it out.

* Xubuntu
* Lubuntu
* Gnome
* Kubuntu
* Mate
* Cinnamon
* Unity

=== SSH Jump Servers
Some personal and corporate plays install a custom SSH configuration which simplifies access to private machines.  Look in `~/.ssh/config` to see what your configuration looks likes.  When I want to access an Amazon EC2 instance in a private subnet, I have to proxy through a Bastion, aka Jump Server, box.  To do that I need to edit the configuration file to make sure I have the proper public address of the Bastion box.

```
Host bastion
    User ec2-user
    HostName ec2-54-218-52-2.us-west-2.compute.amazonaws.com
    IdentityFile ~/Bitbucket/Operations/aws-ssh-keys/us-west-2/asgard-lite-test.pem
    ForwardAgent yes

Host 10.0.*.*
    User ec2-user
    IdentityFile ~/Bitbucket/Operations/aws-ssh-keys/us-west-2/asgard-lite-test.pem
    ProxyCommand ssh bastion -W %h:%p
    ExitOnForwardFailure yes
```

To test out the configuration, try `ssh bastion`.  Once that is working, try connecting to an internal box `ssh 10.20.30.40` and see if that works.  The same setup works for accessing your home network.

== Troubleshooting

=== My Network Does Not Seem To Be Functioning?
BY default the box is configured to appear as a node on the network, allowing others to connect to services on your machine.  You can try putting the box into NAT-only mode to see if that fixes things for you. Edit `vagrantfile`, commenting out the `config.vm.network` setting like so:

```
    # put the box on the network so it can be accessed by others
#   config.vm.network "public_network"

```

=== I've upgrade to kurron/xenial-xubuntu:5.1.28 and things are acting weird
As of October 1, 2017, the 5.1.28 box has not been officially announced because the switch over from JDK 8 to JDK 9 is still undergoing tests.  If you upgraded and are seeing odd behavior, there are a few simple edits to fix things.

=== IDE Desktop Launchers
Right mouse click on your IDE's desktop icon and select `Properties` and then the `Launcher` tab.  You'll need to edit the `Command` to point to JDK 8. Here is an example for the PyCharm launcher `env PYCHARM_JDK=/usr/lib/jvm/jdk-8 /home/vagrant/Software/pycharm/bin/pycharm.sh`. If you are **not** doing any JVM development, then this is all you need to do.

=== JVM Developers
JVM developers will need to get `JAVA_HOME` and other environment variables to point to JDK 8.  To do this, edit two files:

* /etc/environment
* /etc/profile.d/default-jdk-environment.sh

Once those are changed, log out and back in again and run `echo $JAVA_HOME` and `java -version` to verify your changes.

=== Where did `/vagrant` go?
There is http://stackoverflow.com/questions/42074246/vagrant-error-unable-to-mount-virtualbox-shared-folders-guest-additions-vboxs[an issue with Windows 10 and VirtualBox 5.1.16] that prevents Vagrant from starting properly.  As a workaround, we've disabled sharing of folders.  Non-Windows users can edit the `vagrantfile` and re-enable the mount if desired.

TIP: The issue has been resolved in VirtualBox 5.1.18.  The `/vagrant` folder is now mounted as usual.

=== Vagrant Asks Me Which Network Interface To Bind To
By default, the box is configured to join the local network as a fully accessible machine. The `desktop.vm.network "public_network"` in the `vagrantfile` is the key to this.  If you have multiple networks available on your machine, running a VPN for example, Vagrant needs to know which network you want to put your Vagrant box onto and will wait until you give it guidance.

```
==> desktop: Setting the name of the VM: jvmguy.desktop
==> desktop: Clearing any previously set network interfaces...
==> desktop: Available bridged network interfaces:
1) Intel(R) 82579V Gigabit Network Connection
2) Juniper Networks Virtual Adapter
==> desktop: When choosing an interface, it is usually the one that is
==> desktop: being used to connect to the internet.
    desktop: Which interface should the network bridge to?
```

=== Vagrant Box Does Not Come Up
If you find that when you are building a new box that it does not come up, try going into the `Settings->USB` section of your box in the VirtuabBox UI and disabling the USB controller. If you want USB support, make sure you have installed https://www.virtualbox.org/wiki/Downloads[VM VirtualBox Extension Pack].

You should also double check that you have **enabled virtualization support** in your BIOS.

=== Partial Failure
Sometimes networks fail or mirror sites go down. If you experience a failure, you can attempt to resume the construction by issuing `vagrant provision` at the command line.  Vagrant will attempt to start over, but will skip any provisions that have already taken place.

=== Cannot Acquire Repository Lock
TIP: We've altered some of the installation logic to perform the retry logic described below automatically so you probably don't have to worry about this scenario any longer.

One of the first steps is to update the APT repositories via `apt-get update` which every once in a while can fail. What appears to happen in those cases is that the Ubuntu GUI has already acquired the lock and is running the update on its own.  The solution is to wait a bit and then reset the environment so that provisioning can continue.  This issue will manifest in "Ansible is not installed" errors.

1. `vagrant ssh`
1. `sudo rm /var/lib/dpkg/lock` to remove the lock file
1. `sudo apt-get update` -- repeat this step until you can successfully acquired the lock and update
1. `sudo rm /var/ansible-install`
1. `exit`
1. `vagrant provision` should resume the provisioning of the box

=== My Git settings are all wrong!
You need to specify a custom Git configuration file.  The best way to do that is to create and apply your own customizations. See the *Applying Your Own Customizations* section above on how to do that.  You can use https://github.com/kurron/ansible-pull-desktop-tweaks[kurron/ansible-pull-desktop-tweaks.git] as inspiration.

CAUTION: Do not blindly copy the customizations as they are specific to a particular person.

=== I lost power and now VPN isn't working!
.From Nick
[quote]
____
I guess this is just an FYI to anybody who might have also had this problem, but if you are using the VPN on the guest boxes, it will edit your `resolv.conf` file to only use TLs nameservers.  If you lose power, these will remain in this state and you will lose DNS the next time you start the machine (seeing that you no longer have a VPN session).  I found just starting and stopping the scripts in `~/VPN` would restore the `resolv.conf` back to normal.
____

=== I'm running Windows 7 and Vagrant hangs!
You need to install a current version of https://www.microsoft.com/en-us/download/details.aspx?id=40855[Windows Management Framework] and then reboot your machine.  Apparently, there is a compatibility issue older PowerShell and newer Vagrant versions.

== Change History

1. Release 5.2.5
    * Upgraded: Kernel 4.4.0-104-generic
    * Upgraded: JDK 1.8.0_152
    * Upgraded: SDKMAN! SDKMAN 5.6.0+287
    * Upgraded: Python Python 3.5.2
    * Upgraded: Legacy Python Python 2.7.12
    * Upgraded: Edge Python Python 3.6.4
    * Upgraded: Virtualenv 15.1.0
    * Upgraded: Docker Docker version 17.12.0-ce, build c97c6d6
    * Upgraded: Docker Compose docker-compose version 1.18.0, build 8dd22a9
    * Upgraded: Docker Machine docker-machine version 0.13.0, build 9ba6da9
    * Upgraded: AWS CLI aws-cli/1.11.125 Python/2.7.12 Linux/4.4.0-104-generic botocore/1.5.88
    * Upgraded: AWS ECS CLI ecs-cli version 1.2.0 (8d555ea)
    * Upgraded: Kubectl Client Version: version.Info{Major:"1", Minor:"9", GitVersion:"v1.9.0", GitCommit:"925c127ec6b946659ad0fd596fa959be43f0cc05", GitTreeState:"clean", BuildDate:"2017-12-15T21:07:38Z", GoVersion:"go1.9.2", Compiler:"gc", Platform:"linux/amd64"}
    * Upgraded: localstack 0.8.3
    * Upgraded: Sysdig sysdig version 0.19.1
    * Upgraded: Faco falco version 0.8.1
    * Upgraded: Consul Consul v1.0.2
    * Upgraded: Consul Replicate consul-replicate v0.4.0 (886abcc)
    * Upgraded: Consul Template consul-template v0.19.4 (68b1da2)
    * Upgraded: Nomad Nomad v0.7.1 (0b295d399d00199cfab4621566babd25987ba06e)
    * Upgraded: Packer 1.1.3
    * Upgraded: Terraform Terraform v0.11.1
    * Upgraded: Vault Vault v0.9.1 ('87b6919dea55da61d7cd444b2442cabb8ede8ab1')
    * Upgraded: NodeJS v6.12.2
    * Upgraded: NPM 3.10.10
    * Upgraded: Yeoman 2.0.0
    * Upgraded: Bower 1.8.2
    * Upgraded: Gulp [09:56:42] CLI version 2.0.0
    * Upgraded: Grunt grunt-cli v1.2.0
    * Upgraded: Servless 1.25.0
    * Upgraded: IntelliJ IDEA 2017.3.2
    * Upgraded: PyCharm 2017.3.2
    * Upgraded: WebStorm 2017.3.2
    * Upgraded: DataGrip 2017.3.3
    * Upgraded: Charles Proxy 4.2.1
    * Upgraded: Atom 1.23.1
    * Upgraded: Visual Studio Code 1.19.1
    * Upgraded: MongoDB Compass 1.11.1
    * Upgraded: VisualVM 1.4
1. Release 5.1.29
    * Upgraded: IDEA 2017.2.5
    * Upgraded: Made JDK 8 default JVM (JDK 9 is also installed)
1. Release 5.1.28
    * Upgraded: VirtualBox 5.1.28
    * Upgraded: Vagrant 2.0.0
    * Added: Java 9.0.0.15 **(now default JDK)**
    * Upgraded: Java 1.8.0_144 (keeping during transition to Java 9)
    * Upgraded: Docker 17.07.0-ce
    * Upgraded: Docker Compose 1.16.1
    * Upgraded: Ansible 2.4.0.0
    * Upgraded: Node JS 6.11.3
    * Upgraded: Consul 0.9.3
    * Upgraded: Terraform 0.10.6
    * Upgraded: Linux Kernel 4.4.0-96-generic
    * Upgraded: WebStorm 2017.2.4
    * Upgraded: IDEA 2017.2.4
    * Upgraded: Kubernetes 1.7.6
    * Upgraded: PyCharm 2017.2.3
    * Upgraded: Atom 1.20.1
    * Upgraded: DataGrip 2017.2.2
    * Upgraded: Atlassian's localstack 0.8.0
    * Upgraded: Visual Studio Code 1.16.1
    * Upgraded: MongoDB Compass 1.8.2
    * Removed: logFACES (broken and nobody was complaining about it)
1. Release 5.1.26
    * Juniper VPN support
    * Upgraded: VirtualBox 5.1.26
    * Upgraded: Vagrant 1.9.7
    * Upgraded: Docker 17.06.0-ce
    * Upgraded: Docker Compose 1.15.0
    * Upgraded: Ansible 2.3.1.0
    * Upgraded: AWS CLI 1.11.86
    * Upgraded: Node JS 6.11.1
    * Upgraded: NPM 3.10.10
    * Upgraded: Consul 0.9.0
    * Upgraded: Linux Kernel 4.4.0-87-generic
    * Upgraded: WebStorm 2017.2
    * Upgraded: IDEA 2017.2
    * Upgraded: Kubernetes 1.7.2
    * Upgraded: PyCharm 2017.2
    * Upgraded: Atom 1.18.0
    * Upgraded: DataGrib 2017.2
    * Added: Serverless Framework
    * Added: Sysdig's Falco
    * Removed: docker-py module
    * Added: Atlassian's localstack (AWS emulator)
    * Added: Visual Studio Code
    * Added: MongoDB Compass
    * Removed: JHipster
1. Release 5.1.22
    * VirtualBox 5.1.22 support
    * Vagrant 1.9.4 support
    * kernel 4.4.0-75
    * Zulu JDK to 8.0.131
    * Docker Engine v17.04.0-ce
    * Docker Compose 1.12.0
    * Docker Machine 0.11.0
    * IntelliJ 2017.1.2
    * PyCharm 2017.1.2
    * WebStorm 2017.1.2
    * Sysdig 0.15.1
    * VisualVM 1.3.9
    * Consul to 0.8.1
    * Consul Template to 0.18.2
    * Nomad to 0.5.6
    * Terraform to 0.9.4
    * Vault to 0.7.0
    * Charles proxy 4.1.1
    * kubectl 1.6.2
    * Python 3.6 (`/usr/bin/python3.6`)
    * Atom 1.16.0
    * DataGrip 2017.1.2
    * logFaces 4.3.2
    * HTTPie 0.9.9
    * npm 3.10.10
    * node v6.10.2
1. Release 5.1.18
    * VirtualBox 5.1.18 support
    * Nomad 0.5.5
    * Terraform 0.9.0
    * Atom 1.15.0
    * AWS CLI 1.11.63
1. Release 5.1.16
    * VirtualBox 5.1.16 support
    * Vagrant 1.9.2 support
    * Docker 17.03.0-ce
    * Docker Compose 1.11.2
    * Ansible 2.2.1.0
    * AWS CLI 1.11.59
    * NodeJS v6.10.0
    * NPM 3.10.10
    * Consul v0.7.5
    * Nomad v0.5.4
    * Packer 0.12.3
    * WebStorm 2016.3.4
    * IntelliJ 2016.3.5
    * DataGrip 2016.3.4
    * Atom 1.14.4
    * Sysdig 0.15.0
1. Release 5.1.14
    * Azul JDK is now the default, Oracle is still available if needed
    * Oracle JDK updated to 1.8.0_121
    * AWS CLI updated to 1.11.41
    * ECS CLI updated to 0.4.6
    * Sysdig updated to 0.13.0
    * NodeJS updated to 6.9.4
    * logFACES updated to 4.3.1
    * DataGrip updated to 2016.3.2
    * PyCharm updated to 2016.3.2
    * IntelliJ IDEA updated to 2016.3.3
    * Atom updated to 1.13.0
    * Docker Engine updated to 1.13.0
    * Docker Compose updated to 1.10.0
    * Consul Replicate updated to 0.3.0
    * Consul Template updated to 0.18.0
    * Consul Env updated to 0.6.2
    * Nomad updated to 0.5.2
    * Packer updated to 0.12.2
    * Terraform update to 0.8.4
    * Added missing Atlassian repository keys
1. Release 5.1.12
    * VirtualBox 5.1.12 support,
    * RedHat now has a current version of Git installed.
    * Firefox, Chromium and Evince now installed by default.
    * Numerous version upgrades.
1. Release 5.1.10
    * Smaller download,
    * replaced ext4 with xfs,
    * updates to Docker, IntelliJ, PyCharm, WebStorm, Node JS, Atom, Packer
    * VirtualBox 5.1.10 support
1. Release 5.1.8
    * VirtualBox 5.1.8 support

== License and Credits
This project is licensed under the http://www.apache.org/licenses/[Apache License Version 2.0, January 2004].
